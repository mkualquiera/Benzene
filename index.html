<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
    <!---<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'">
    <meta http-equiv="X-Content-Security-Policy" content="default-src 'self'; script-src 'self'">--->
    <link rel="stylesheet" type="text/css" href="litegraph.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <script type="text/javascript" src="litegraph.js"></script>
    <title>Hello World!</title>
</head>

<body style='width:100%; height:100%'>
    <canvas id='mycanvas'></canvas>
    <script type="text/javascript" , src="nodeEditor.js"></script>
    <div class="ontop" style="left:20px; top:20px;">
        <button class="menubutton" onclick="saveAs()">Save as</button>
        <button class="menubutton" onclick="save()">Save</button>
        <button class="menubutton" onclick="load()">Load</button>
        <button class="menubutton" id="newfileb" onclick="newfile()">New</button>
    </div>
    <script>

        var savingPath = null;
        var saveVersion = -2;

        const { ipcRenderer } = require('electron');

        ipcRenderer.on('requestSave', () => {
            save();
        });

        ipcRenderer.on('requestSaveAs', () => {
            saveAs();
        });

        ipcRenderer.on('requestLoad', (event, data) => {
            graph.configure(JSON.parse(data))
        });

        ipcRenderer.on('saveSuccess', (event) => {
            saveVersion = graph._version;
        })

        setInterval(()=> {
            if (saveVersion != graph._version) {
                console.log(saveVersion, graph._version);
                ipcRenderer.send('notSaved');
            } else {
                ipcRenderer.send('yesSaved');
            } 
        },500);

        saveAs = function () {
            ipcRenderer.send('saveAs');
        }

        save = function () {
            var data = JSON.stringify(graph.serialize());
            ipcRenderer.send('save', data);
        }

        load = function () {
            ipcRenderer.send('loadFile');
        }

        var newfilebutton = document.getElementById("newfileb");
        newfilebutton.addEventListener("mouseleave", (e) => {
            if (newfilebutton.classList.contains("confirmbutton")) {
                newfilebutton.classList.remove("confirmbutton");
            }
        }) 

        newfile = function() {
            if (newfilebutton.classList.contains("confirmbutton")) {
                newfilebutton.classList.remove("confirmbutton");
                saveVersion = -2;
                graph.clear()
                ipcRenderer.send('clear');
            } else {
                newfilebutton.classList.add("confirmbutton");
            }
        }

        // define a handler
        function doc_keyUp(e) {

            // this would test for whichever key is 40 (down arrow) and the ctrl key at the same time
            if (e.ctrlKey && e.shiftKey && e.key === 'S') {
                // call your function to do the thing
                saveAs()
                return;
            }
            if (e.ctrlKey && e.key === 's') {
                // call your function to do the thing
                save()
                return;
            }
            if (e.ctrlKey && e.key === 'o') {
                // call your function to do the thing
                load()
                return;
            }
        }
        // register the handler 
        document.addEventListener('keyup', doc_keyUp, false);
    </script>
</body>

</html>